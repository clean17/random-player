<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Video Player</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="top-bar">
        <div class="back">
            <a href="{{ url_for('main.home') }}">Back</a>
        </div>
        <div class="logout">
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('auth.logout') }}">Logout</a>
            {% endif %}
        </div>
    </div>
    <div id="videoContainer">
        <video id="videoPlayer" controls autoplay></video>
        <div id="controls">
            <button id="deleteButton">Delete</button>
            <button id="nextButton">Next</button>
        </div>
    </div>
    
    <script>
        let currentVideo = '';
        let controls = document.querySelector('#controls');
        let topDiv = document.querySelector('.top-bar');
        let directory = "{{ directory }}";
        let videoPlayer = document.querySelector('#videoPlayer');

        let hideControlsTimeout;

        const hideControls = () => {
            clearTimeout(hideControlsTimeout);
            hideControlsTimeout = setTimeout(() => {
                controls.style.display = 'none';
                topDiv.style.display = 'none';
            }, 2000);
        };

        const showControls = () => {
            controls.style.display = 'block';
            topDiv.style.display = 'block';
            hideControls();
        };

        document.getElementById('nextButton').removeEventListener('click', getVideo);
        document.getElementById('nextButton').addEventListener('click', getVideo);
        document.getElementById('deleteButton').removeEventListener('click', delVideo);
        document.getElementById('deleteButton').addEventListener('click', delVideo);

        function getVideo() {
            fetch(`/video/videos?directory=${directory}`)
                .then(response => response.json())
                .then(videos => {
                    if (videos.length > 0) {
                        currentVideo = videos[0];
                        videoPlayer.src = `/video/video/${encodeURIComponent(currentVideo)}?directory=${directory}`;
                    } else {
                        alert('No videos found');
                    }
                });
        }

        function delVideo() {
            if (currentVideo) {
                if (confirm("Are you sure?")) {
                    videoPlayer.pause();
                    videoPlayer.src = '';
                    videoPlayer.load();

                    fetch(`/video/delete/${encodeURIComponent(currentVideo)}?directory=${directory}`, {
                        method: 'DELETE'
                    }).then(response => {
                        if (response.status === 204) {
                            currentVideo = '';
                            getVideo();
                        } else {
                            alert('Failed to delete video');
                        }
                    });
                }
            }
        }

        videoPlayer.addEventListener('play', showControls);
        videoPlayer.addEventListener('pause', showControls);
        videoPlayer.addEventListener('click', showControls);
        videoPlayer.addEventListener('touchstart', showControls);
        videoPlayer.addEventListener('ended', getVideo);

        videoPlayer.addEventListener('mousemove', showControls);
        videoPlayer.addEventListener('touchmove', showControls);

        function initPage() {
            getVideo();
        }

        document.addEventListener("DOMContentLoaded", initPage)
    </script>
</body>
</html>
