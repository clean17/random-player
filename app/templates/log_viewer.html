<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Viewer</title>
<!--    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>-->
    <script src="/static/js/common.js?v={{ version }}"></script>
    <link rel="stylesheet" href="/static/css/style.css?v={{ version }}">
    <style>
        body, html {
            background-color: #f4f4f4;
            height: 100%;
            overflow: hidden;   /* í˜ì´ì§€ ìì²´ ìŠ¤í¬ë¡¤ ë§‰ê¸° */
        }
        .container {
            min-width: 400px; /* ëª¨ë°”ì¼ì—ì„œ ë³´ê¸° ì¢‹ê²Œ ë‚˜ì˜¨ë‹¤ */
            max-width: 80vw;
            height: 100%;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨í•˜ì—¬ í¬ê¸° ì¡°ì • */

            display: flex;
            flex-direction: column;
            min-height: 0; /* í”Œë ‰ìŠ¤ ì»¨í…Œì´ë„ˆì—ì„œ ë‚´ë¶€ ìŠ¤í¬ë¡¤ í—ˆìš© */
        }
        #date-picker { margin: 3px 10px 10px 10px}
        .datepicker-block { display: flex; justify-content: center}
    </style>
</head>
<body>
<div class="top-bar">
    <div class="logout">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">Logout</a>
        {% endif %}
    </div>
    <div class="back">
        <a href="{{ url_for('main.home') }}">Back</a>
    </div>
</div>

<div class="container">
    <h2>ë¡œê·¸ ë·°ì–´</h2>
    <div class="datepicker-block">
        <label for="date-picker">ë‚ ì§œ ì„ íƒ:</label>
        <input type="date" id="date-picker">
        <span id="sse-status">ì—°ê²° ìƒíƒœ ğŸ”„</span>
    </div>
    <pre id="log-container"></pre>
</div>

<script>
    // const socket = io()  // WebSocket ì—°ê²°
    const logContainer = document.getElementById("log-container"),
          datePicker = document.getElementById("date-picker"),
          eventSource = new EventSource("/func/logs/stream"),
          statusEl = document.getElementById("sse-status");

    const ipKeywords = [" 122.42", " 223.39", " 223.38", " 116.46", " 27.171", " 223.63", " 211.251", " 211.195", " 49.172"];

    // ì‹¤ì‹œê°„ ë¡œê·¸ ì—…ë°ì´íŠ¸ (ì˜¤ëŠ˜ ë¡œê·¸ì¼ ë•Œë§Œ WebSocket ì‚¬ìš©)
    /*socket.on("log_update", (data) => {
        const selectedDate = datePicker.value;
        if (selectedDate === getTodayDate()) {
            appendLog(data.log);
        }
    });*/

    function updateStatus() {
        switch (eventSource.readyState) {
            case 0:
                statusEl.textContent = "ì—°ê²° ìƒíƒœ ğŸŸ¡";
                break;
            case 1:
                statusEl.textContent = "ì—°ê²° ìƒíƒœ ğŸŸ¢";
                break;
            case 2:
                statusEl.textContent = "ì—°ê²° ìƒíƒœ ğŸ”´";
                break;
        }
    }

    setInterval(updateStatus, 100);

    eventSource.onerror = updateStatus;
    eventSource.onopen = updateStatus;

    // ì˜¤ëŠ˜ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (YYYY-MM-DD í˜•ì‹)
    function getTodayDate() {
        const now = new Date();
        const kstOffset = 9 * 60 * 60 * 1000; // 9ì‹œê°„ offset
        const kstDate = new Date(now.getTime() + kstOffset);
        return kstDate.toISOString().split("T")[0];

        /*const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;*/
    }

    // ì˜¤ëŠ˜ ë¡œê·¸ë§Œ ë·°ì–´ì— ì¶”ê°€
    eventSource.onmessage = (event) => {
        const selectedDate = datePicker.value;
        if (selectedDate === getTodayDate()) {
            appendLog(event.data)
        }
    };

    // span ìœ¼ë¡œ ê°ì‹¸ë„ë¡ ìˆ˜ì •
    function appendLog(line) {
        // logContainer.textContent += line + "\n";

        // const newLine = line.trim();
        // const lines = logContainer.textContent.trim().split("\n");
        // const lastLine = lines[lines.length - 1];
        const newLines = line.trim().split("\n");
        const lines = Array.from(logContainer.querySelectorAll("span"));
        const lastLine = lines.length ? lines[lines.length - 1].textContent : "";

        // ì •ê·œì‹ ì‹œê°„ëŒ€ 2025-05-07 00:10:50,192
        const timePattern = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}/;
        const lastTimestampMatch = lastLine.match(timePattern);
        // const newLineTimestampMatch = newLine.match(timePattern);
        const newFirstTimestampMatch = newLines[0].match(timePattern);

        // ë™ì¼í•œ ë¡œê·¸ê°€ 2ë²ˆ ê¸°ë¡ë˜ëŠ” ì´ìŠˆ ìˆ˜ì • > ì‹œê°„ì´ ê°™ì§€ ì•Šìœ¼ë©´ ì¶”ê°€
        // if (!lastTimestampMatch || !newLineTimestampMatch || lastTimestampMatch[0] !== newLineTimestampMatch[0]) {
        if (!lastTimestampMatch || !newFirstTimestampMatch || lastTimestampMatch[0] !== newFirstTimestampMatch[0]) {
            // logContainer.textContent += line + "\n";

            // span íƒœê·¸ë¥¼ ë§Œë“¤ì–´ì„œ ê° ë¼ì¸ë³„ ìŠ¤íƒ€ì¼ ê´€ë¦¬í•˜ë ¤ê³  í•¨
            for (const subline of newLines) {
                const span = document.createElement("span");
                span.textContent = subline;
                span.style.display = "block";

                if (subline.includes("ERROR")) {
                    span.style.backgroundColor = "tomato";
                    span.style.color = "white";
                }
                if (ipKeywords.some(keyword => subline.includes(keyword))) {
                    span.style.backgroundColor = "Lightgoldenrodyellow";
                }

                logContainer.appendChild(span);
            }
        }
    }

    // ë‚ ì§œë³„ ë¡œê·¸ ê°€ì ¸ì˜¤ê¸°
    function loadLogs() {
        const dateInput = datePicker.value;
        if (!dateInput) {
            alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        // YYYY-MM-DD â†’ YYMMDD ë³€í™˜
        const formattedDate = dateInput.replace(/-/g, "").slice(2);

        // ì´ì „ ë¡œê·¸ í˜¸ì¶œ
        fetch(`/func/logs/${formattedDate}`,
              { cache: "no-cache" }, // ğŸ”¥ ìºì‹± ë°©ì§€ ì¶”ê°€
            )
            .then(response => response.text()) // json -> text
            .then(data => {
                showDebugToast("ë°ì´í„° ë¡œë”© ì„±ê³µ");
                // logContainer.textContent = data;
                // logContainer.scrollTop = logContainer.scrollHeight; // âœ… ìë™ ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ
                appendLog(data)
            })
            .then(() => {
                logContainer.scrollTop = logContainer.scrollHeight; // âœ… ìë™ ìŠ¤í¬ë¡¤ ì•„ë˜ë¡œ
            })
            .catch(error => console.error("ë¡œê·¸ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error))
    }

    // ì°½ìœ¼ë¡œ ë“¤ì–´ì˜¤ë©´ ìƒˆë¡œê³ ì¹¨
    document.addEventListener('visibilitychange', () => {
        // window.location.href = '/func/logs/view'; // home ìœ¼ë¡œ ê°ˆ ìˆ˜ ì—†ìŒ..
        if (!document.hidden) {
            logContainer.innerText = '';
            setTimeout(()=>{loadLogs()},100);
        }
    })

    function initPage() {
        datePicker.value = getTodayDate();
        loadLogs();
        datePicker.removeEventListener('change', loadLogs)
        datePicker.addEventListener('change', loadLogs)
    }

    document.addEventListener("DOMContentLoaded", initPage);

    // í˜ì´ì§€ê°€ ì–¸ë¡œë“œë  ë•Œ SSE ì—°ê²° ì¢…ë£Œ
    window.addEventListener("beforeunload", () => {
        eventSource.close();
    });
</script>


</body>
</html>