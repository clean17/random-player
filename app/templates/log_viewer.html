<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î°úÍ∑∏ Î∑∞Ïñ¥</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/directory_select.css') }}">
    <style>
        /*body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }*/
        #log-container { width: 99%; height: 700px; overflow-y: scroll; background: #fff; padding: 10px; border: 1px solid #ccc; text-align: left }
        .log-line { white-space: pre-wrap; font-family: monospace; }
        #date-picker { margin: 0px 10px 10px 10px}
    </style>
</head>
<body>
<div class="top-bar">
    <div class="logout">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">Logout</a>
        {% endif %}
    </div>
    <div class="back">
        <a href="{{ url_for('main.home') }}">Back</a>
    </div>
</div>
<div class="container">
    <h2>Î°úÍ∑∏ Î∑∞Ïñ¥</h2>
    <div style="display: flex; justify-content: center;">
        <label for="date-picker">ÎÇ†Ïßú ÏÑ†ÌÉù:</label>
        <input type="date" id="date-picker">
        <button onclick="loadLogs()" style="max-width: 12%; height: 22px; font-size: 12pt; padding: 0px 10px">Î°úÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞</button>
    </div>
    <div id="log-container"></div>
</div>

<script>
    const logContainer = document.getElementById("log-container");
    // const socket = io()  // WebSocket Ïó∞Í≤∞
    let eventSource = null; // SSE Ïó∞Í≤∞

    // Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏ (Ïò§Îäò Î°úÍ∑∏Ïùº ÎïåÎßå WebSocket ÏÇ¨Ïö©)
    /*socket.on("log_update", (data) => {
        const selectedDate = document.getElementById("date-picker").value;
        if (selectedDate === getTodayDate()) {
            renderLogs(data.log)
        }
    });*/

    // Ïò§Îäò ÎÇ†Ïßú Í∞ÄÏ†∏Ïò§Í∏∞ (YYYY-MM-DD ÌòïÏãù)
    function getTodayDate() {
        const today = new Date();
        return today.toISOString().split("T")[0]; // "YYYY-MM-DD" ÌòïÏãù Î∞òÌôò
    }

    // SSE Ïä§Ìä∏Î¶º ÏãúÏûë
    function startSSE() {
        if (eventSource) {
            eventSource.close(); // Í∏∞Ï°¥ Ïó∞Í≤∞ Ï¢ÖÎ£å
        }

        eventSource = new EventSource("/func/logs/stream");

        eventSource.onmessage = (event) => {
            // console.log('msg', event.data)
            renderLogs(event.data)
        };

        eventSource.onerror = () => {
            console.error("SSE Ïó∞Í≤∞ Ïò§Î•ò. Ïû¨Ïó∞Í≤∞ Ï§ë...");
            eventSource.close();
            setTimeout(startSSE, 3000); // 3Ï¥à ÌõÑ Ïû¨Ïó∞Í≤∞
        };
    }

    function renderLogs(log) {
        const logLine = document.createElement("div");
        logLine.classList.add("log-line");
        logLine.textContent = log;
        logContainer.appendChild(logLine);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    // ÎÇ†ÏßúÎ≥Ñ Î°úÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞
    function loadLogs() {
        const dateInput = document.getElementById("date-picker").value;
        if (!dateInput) {
            alert("ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
            return;
        }

        // Ïò§Îäò ÎÇ†ÏßúÏù∏ Í≤ΩÏö∞ SSE ÏÇ¨Ïö©
        if (dateInput === getTodayDate()) {
            logContainer.innerHTML = ""; // Í∏∞Ï°¥ Î°úÍ∑∏ Ï¥àÍ∏∞Ìôî
            startSSE(); // SSE ÏãúÏûë
            return;
        }

        // Í≥ºÍ±∞ Î°úÍ∑∏ ÏöîÏ≤≠ Ïãú SSE Ï¢ÖÎ£å
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }

        // YYYY-MM-DD ‚Üí YYMMDD Î≥ÄÌôò
        const formattedDate = dateInput.replace(/-/g, "").slice(2);

        // Ïù¥Ï†Ñ Î°úÍ∑∏ Ìò∏Ï∂ú
        fetch(`/func/logs/${formattedDate}`, { cache: "no-cache" })  // üî• Ï∫êÏã± Î∞©ÏßÄ Ï∂îÍ∞Ä
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    logContainer.innerHTML = `<p style="color:red;">${data.error}</p>`;
                } else {
                    logContainer.innerHTML = "";
                    data.logs.forEach(log => renderLogs(log));
                }
            })
            .catch(error => console.error("Î°úÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:", error));
    }

    function initPage() {
        document.getElementById("date-picker").value = getTodayDate();
        loadLogs();
    }

    document.addEventListener("DOMContentLoaded", initPage);
</script>


</body>
</html>
