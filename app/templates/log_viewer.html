<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Viewer</title>
<!--    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>-->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/directory_select.css') }}">
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4;}
        #log-container {height: 71vh; overflow-y: scroll; background: #fff; padding: 10px; border: 1px solid #ccc; text-align: left }
        #date-picker { margin: 0px 10px 10px 10px}
    </style>
</head>
<body>
<div class="top-bar">
    <div class="logout">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">Logout</a>
        {% endif %}
    </div>
    <div class="back">
        <a href="{{ url_for('main.home') }}">Back</a>
    </div>
</div>
<div class="container" style="height: 100%; width: 100%;">
    <h2>Î°úÍ∑∏ Î∑∞Ïñ¥</h2>
    <div style="display: flex; justify-content: center;">
        <label for="date-picker">ÎÇ†Ïßú ÏÑ†ÌÉù:</label>
        <input type="date" id="date-picker">
    </div>
    <pre id="log-container" style="font-family: monospace; white-space: pre;"></pre>
</div>

<script>
    // const socket = io()  // WebSocket Ïó∞Í≤∞
    const logContainer = document.getElementById("log-container"),
          datePicker = document.getElementById("date-picker"),
          eventSource = new EventSource("/func/logs/stream");

    // Ïã§ÏãúÍ∞Ñ Î°úÍ∑∏ ÏóÖÎç∞Ïù¥Ìä∏ (Ïò§Îäò Î°úÍ∑∏Ïùº ÎïåÎßå WebSocket ÏÇ¨Ïö©)
    /*socket.on("log_update", (data) => {
        const selectedDate = datePicker.value;
        if (selectedDate === getTodayDate()) {
            appendLog(data.log);
        }
    });*/

    // Ïò§Îäò ÎÇ†Ïßú Í∞ÄÏ†∏Ïò§Í∏∞ (YYYY-MM-DD ÌòïÏãù)
    function getTodayDate() {
        const now = new Date();
        const kstOffset = 9 * 60 * 60 * 1000; // 9ÏãúÍ∞Ñ offset
        const kstDate = new Date(now.getTime() + kstOffset);
        return kstDate.toISOString().split("T")[0];

        /*const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;*/
    }

    // Ïò§Îäò Î°úÍ∑∏Îßå Î∑∞Ïñ¥Ïóê Ï∂îÍ∞Ä
    eventSource.onmessage = (event) => {
        const selectedDate = datePicker.value;
        if (selectedDate === getTodayDate()) {
            appendLog(event.data)
        }
    };

    // span ÏúºÎ°ú Í∞êÏã∏ÎèÑÎ°ù ÏàòÏ†ï
    function appendLog(line) {
        // logContainer.textContent += line + "\n";

        // const newLine = line.trim();
        // const lines = logContainer.textContent.trim().split("\n");
        // const lastLine = lines[lines.length - 1];
        const newLines = line.trim().split("\n");
        const lines = Array.from(logContainer.querySelectorAll("span"));
        const lastLine = lines.length ? lines[lines.length - 1].textContent : "";

        // Ï†ïÍ∑úÏãù ÏãúÍ∞ÑÎåÄ 2025-05-07 00:10:50,192
        const timePattern = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}/;
        const lastTimestampMatch = lastLine.match(timePattern);
        // const newLineTimestampMatch = newLine.match(timePattern);
        const newFirstTimestampMatch = newLines[0].match(timePattern);

        // ÎèôÏùºÌïú Î°úÍ∑∏Í∞Ä 2Î≤à Í∏∞Î°ùÎêòÎäî Ïù¥Ïäà ÏàòÏ†ï > ÏãúÍ∞ÑÏù¥ Í∞ôÏßÄ ÏïäÏúºÎ©¥ Ï∂îÍ∞Ä
        // if (!lastTimestampMatch || !newLineTimestampMatch || lastTimestampMatch[0] !== newLineTimestampMatch[0]) {
        if (!lastTimestampMatch || !newFirstTimestampMatch || lastTimestampMatch[0] !== newFirstTimestampMatch[0]) {
            // logContainer.textContent += line + "\n";

            // span ÌÉúÍ∑∏Î•º ÎßåÎì§Ïñ¥ÏÑú Í∞Å ÎùºÏù∏Î≥Ñ Ïä§ÌÉÄÏùº Í¥ÄÎ¶¨ÌïòÎ†§Í≥† Ìï®
            for (const subline of newLines) {
                const span = document.createElement("span");
                span.textContent = subline;
                span.style.display = "block";

                if (subline.includes("ERROR")) {
                    span.style.backgroundColor = "tomato";
                    span.style.color = "white";
                }
                const ipKeywords = ["122.42", "223.39", "223.38", "116.46"];
                if (ipKeywords.some(keyword => subline.includes(keyword))) {
                    span.style.backgroundColor = "Lightgoldenrodyellow";
                }

                logContainer.appendChild(span);
            }
        }
        logContainer.scrollTop = logContainer.scrollHeight; // ‚úÖ ÏûêÎèô Ïä§ÌÅ¨Î°§ ÏïÑÎûòÎ°ú
    }

    // ÎÇ†ÏßúÎ≥Ñ Î°úÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞
    function loadLogs() {
        const dateInput = datePicker.value;
        if (!dateInput) {
            alert("ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
            return;
        }

        // YYYY-MM-DD ‚Üí YYMMDD Î≥ÄÌôò
        const formattedDate = dateInput.replace(/-/g, "").slice(2);

        // Ïù¥Ï†Ñ Î°úÍ∑∏ Ìò∏Ï∂ú
        fetch(`/func/logs/${formattedDate}`, { cache: "no-cache" })  // üî• Ï∫êÏã± Î∞©ÏßÄ Ï∂îÍ∞Ä
            .then(response => response.text()) // json -> text
            .then(data => {
                // document.getElementById("log-container").textContent = data;
                // logContainer.scrollTop = logContainer.scrollHeight; // ‚úÖ ÏûêÎèô Ïä§ÌÅ¨Î°§ ÏïÑÎûòÎ°ú
                appendLog(data)
            })
            .catch(error => console.error("Î°úÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:", error))
    }

    function initPage() {
        datePicker.value = getTodayDate();
        loadLogs();
        datePicker.removeEventListener('change', loadLogs)
        datePicker.addEventListener('change', loadLogs)
    }

    document.addEventListener("DOMContentLoaded", initPage);

    // ÌéòÏù¥ÏßÄÍ∞Ä Ïñ∏Î°úÎìúÎê† Îïå SSE Ïó∞Í≤∞ Ï¢ÖÎ£å
    window.addEventListener("beforeunload", () => {
        eventSource.close();
    });
</script>


</body>
</html>