<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>관심 종목 테이블</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/static/js/common.js?v={{ version }}"></script>
    <link rel="stylesheet" href="/static/css/style.css?v={{ version }}">
    <link rel="stylesheet" href="/static/css/interest_stocks.css?v={{ version }}">
</head>
<body>
<div class="top-bar">
    <div class="logout">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">Logout</a>
        {% endif %}
    </div>
    <div class="back">
        <a href="{{ url_for('main.home') }}">Back</a>
    </div>
</div>

<div class="container">
    <div class="tab-bar">
        <button class="tab-btn active" data-target="#tab-trading">실시간 등락</button>
        <button class="tab-btn" data-target="#tab-change">금일 등락</button>
        <input id="dateInput" class="date" type="date" />
    </div>

    <!-- 탭 1: 거래대금 증감% -->
    <section id="tab-trading" class="tab-panel" style="display:block;">
        <h3 class="section-title">실시간 등락
            <span class="badge" id="count-trading">0건</span>
        </h3>
        <div class="table-scroller">
            <table class="table" id="table-trading">
                <thead>
                <tr>
                    <th>그래프</th>
                    <th>등록시간</th>
                    <th>종목명</th>
                    <th>카테고리</th>
                    <th class="right">거래대금(5일 평균)</th>
                    <th class="right">거래대금(실시간)</th>
                    <th class="right">거래대금 증감%</th>
                    <th class="right">어제종가</th>
                    <th class="right">현재가</th>
                    <th class="right">금일 등락%</th>
                </tr>
                </thead>
                <tbody><!-- JS 렌더링 --></tbody>
            </table>
        </div>
    </section>

    <!-- 탭 2: 금일 등락% -->
    <section id="tab-change" class="tab-panel" style="display:none;">
        <h3 class="section-title">금일 등락
            <span class="badge" id="count-change">0건</span>
        </h3>
        <div class="table-scroller">
            <table class="table" id="table-change">
                <thead>
                <tr>
                    <th>그래프</th>
                    <th>등록시간</th>
                    <th>종목명</th>
                    <th>카테고리</th>
                    <th class="right">거래대금(5일 평균)</th>
                    <th class="right">거래대금(금일)</th>
                    <th class="right">거래대금 증감%</th>
                    <th class="right">어제종가</th>
                    <th class="right">금일종가</th>
                    <th class="right">금일 등락%</th>
                </tr>
                </thead>
                <tbody><!-- JS 렌더링 --></tbody>
            </table>
        </div>
    </section>
</div>

<script>
    let timer;
    let timer2;

    const p = new Set();
    const s = new Set();
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
    const dd = String(today.getDate()).padStart(2, '0');

    const today_yyyymmdd = `${yyyy}${mm}${dd}`;



    // 탭 전환
    document.querySelectorAll('.tab-btn[data-target]').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn[data-target]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
            const target = document.querySelector(btn.dataset.target);
            if (target) target.style.display = 'block';
        });
    });

    // 오늘 날짜 기본값
    (function setDefaultDateToday(){
        const input = document.getElementById('dateInput');
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth()+1).padStart(2,'0');
        const dd = String(now.getDate()).padStart(2,'0');
        input.value = `${yyyy}-${mm}-${dd}`;
    })();

    // 숫자 포맷, fmtNum.format(1234567.891); // "1,234,567.89"
    const fmtNum = new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 2 }); // Intl.NumberFormat 은 언어에 맞는 숫자 서식을 지원하는 객체의 생성자
    function fmt2(val) {
        if (val == null || val === '') return '';
        const n = Number(val);
        if (!isFinite(n)) return String(val); // 정상적인 숫자가 아니면 문자열 반환 (안전하게 문자열 처리)
        return fmtNum.format(Math.round(n * 100) / 100); // Math.round(n * 100) / 100 → 소수 둘째 자리까지 반올림
    }

    function fmt_won(val) {
        if (val == null || val === '') return '';
        const n = Number(val);
        if (!isFinite(n)) return String(val);

        if (Math.abs(n) >= 1e12) {
            // 1조 이상 → 소수점 1자리
            return (n / 1e12).toFixed(1).replace(/\.0$/, '') + '조'; // toFixed(n): 소수점 아래 n자리까지 반올림해서 문자열로 반환
        } else if (Math.abs(n) >= 1e8) {
            // 1억 이상 → 소수점 1자리
            return (n / 1e8).toFixed(1).replace(/\.0$/, '') + '억';
        } else if (Math.abs(n) >= 1e4) {
            // 1만 이상 → 천 단위 콤마 + 만원
            return new Intl.NumberFormat('ko-KR').format(Math.round(n / 1e4)) + '만원';
        } else {
            // 1만 미만 그냥 숫자
            return new Intl.NumberFormat('ko-KR').format(Math.round(n));
        }
    }


    // 공통: 그래프 토글 버튼 연결
    function bindImageToggles(scope) {
        scope.querySelectorAll('.img-toggle').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-target');
                const row = document.getElementById(id);
                if (row) row.style.display = row.style.display === 'none' ? '' : 'none';
                btn.textContent = (row && row.style.display !== 'none') ? '닫기' : '열기';
            });
        });
    }

    // 테이블 렌더: 거래대금 증감%
    function renderTradingTable(rows) {
        const tradingTable = document.getElementById('table-trading');
        const thCount = tradingTable.querySelectorAll("thead tr th").length;
        const tbody =    tradingTable.querySelector('tbody');

        if (!rows || !rows.length) {
            tbody.innerHTML = `<tr><td colspan="${thCount}" class="empty">데이터가 없습니다.</td></tr>`;
            document.getElementById('count-trading').textContent = '0건';
            return;
        }
        const html = rows.map(r => {
            const detailId = `detail-tr-${Math.random().toString(36).slice(2)}`;
            const hasImg = !!r.image_url;
            const imgBtn = `<button class="btn img-toggle" data-target="${detailId}" ${hasImg ? '' : 'disabled'}>열기</button>`;
            const date = new Date(`${r.created_at}`);
            const fmt = new Intl.DateTimeFormat("ko-KR", {
                timeZone: "UTC",
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                hour12: false,
            });

            const parts = fmt.formatToParts(date);
            const obj = Object.fromEntries(parts.map(p => [p.type, p.value]));

            // const formatted_date = `${obj.year}.${obj.month}.${obj.day} ${obj.hour}:${obj.minute}`;
            const formatted_date = `${obj.hour}:${obj.minute}`;
            // console.log('formatted_date', formatted_date)
            return `
        <tr>
          <td>${imgBtn}</td>
<!--          <td>${r.stock_code ?? ''}</td>-->
          <td>`+formatted_date+`</td>
          <input type="hidden" class="stock_code" value="${r.stock_code ?? ''}">
          <input type="hidden" class="product_code" value="">
          <td class="stock_name">${r.stock_name ?? ''}</td>
          <td class="">${r.category ?? ''}</td>
          <td class="right avg_amount" data-avg5d-amount="${r.avg5d_trading_value}">${fmt_won(r.avg5d_trading_value)}</td>
          <td class="right cur_amount" data-current-amount="${r.current_trading_value}">${fmt_won(r.current_trading_value)}</td>
          <td class="right tv_change">${fmt2(r.trading_value_change_pct)}%</td>
          <td class="right yst_close">${fmt2(r.yesterday_close)}원</td>
          <td class="right cur_close">${fmt2(r.current_price)}원</td>
          <td class="right prc_change">${fmt2(r.today_price_change_pct)}%</td>
        </tr>
        <tr id="${detailId}" class="detail-row" style="display:none;">
          <td colspan="${thCount}">
            ${hasImg ? `<img class="preview" src="https://chickchick.shop/image/stock-graphs/interest/${r.image_url}" alt="미리보기" />` : `<span class="hint">그래프 없음</span>`}
          </td>
        </tr>`;
        }).join('');
        tbody.innerHTML = html;
        document.getElementById('count-trading').textContent = `${rows.length}건`;
        bindImageToggles(document.getElementById('table-trading'));
    }

    // 테이블 렌더: 금일 등락%
    function renderChangeTable(rows) {
        const changeTable = document.getElementById('table-change');
        const thCount = changeTable.querySelectorAll("thead tr th").length;
        const tbody =    changeTable.querySelector('tbody');
        if (!rows || !rows.length) {
            tbody.innerHTML = `<tr><td colspan="${thCount}" class="empty">데이터가 없습니다.</td></tr>`;
            document.getElementById('count-change').textContent = '0건';
            return;
        }
        const html = rows.map(r => {
            const detailId = `detail-tr-${Math.random().toString(36).slice(2)}`;
            const hasImg = !!r.image_url;
            const imgBtn = `<button class="btn img-toggle" data-target="${detailId}" ${hasImg ? '' : 'disabled'}>열기</button>`;
            const date = new Date(`${r.created_at}`);
            const fmt = new Intl.DateTimeFormat("ko-KR", {
                timeZone: "UTC",
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                hour12: false,
            });

            const parts = fmt.formatToParts(date);
            const obj = Object.fromEntries(parts.map(p => [p.type, p.value]));

            // const formatted_date = `${obj.year}.${obj.month}.${obj.day} ${obj.hour}:${obj.minute}`;
            const formatted_date = `${obj.hour}:${obj.minute}`;
            // console.log('formatted_date', formatted_date)
            return `
        <tr>
          <td>${imgBtn}</td>
          <td>`+formatted_date+`</td>
          <td class="">${r.stock_name ?? ''}</td>
          <td class="">${r.category ?? ''}</td>
          <td class="right">${fmt_won(r.avg5d_trading_value)}</td>
          <td class="right">${fmt_won(r.current_trading_value)}</td>
          <td class="right">${fmt2(r.trading_value_change_pct)}%</td>
          <td class="right">${fmt2(r.yesterday_close)}원</td>
          <td class="right">${fmt2(r.current_price)}원</td>
          <td class="right">${fmt2(r.today_price_change_pct)}%</td>
        </tr>
        <tr id="${detailId}" class="detail-row" style="display:none;">
          <td colspan="${thCount}">
            ${hasImg ? `<img class="preview" src="https://chickchick.shop/image/stock-graphs/interest/${r.image_url}" alt="미리보기" />` : `<span class="hint">그래프 없음</span>`}
          </td>
        </tr>`;
        }).join('');
        tbody.innerHTML = html;
        document.getElementById('count-change').textContent = `${rows.length}건`;
        bindImageToggles(document.getElementById('table-change'));
    }


    // 실시간 가격 업데이트 표시
    function updateTdWithBlink(td, newValue) {
        if (!td) return;

        // 값 교체
        td.textContent = newValue;

        // 깜빡임 클래스 추가 → 애니메이션 실행
        td.classList.add("fade");

        // 애니메이션 끝나면 클래스 제거 (다음에도 실행되도록)
        td.addEventListener("animationend", () => {
            td.classList.remove("fade");
        }, { once: true });
    }


    // 데이터 로드 (날짜 변경 시 자동 호출)
    async function loadData() {
        const input = document.getElementById('dateInput');
        const yyyymmdd = input.value?.replace(/-/g, '');

        const url = 'https://chickchick.shop/func/stocks/interest/data';
        const payload = { date: yyyymmdd };

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
                body: JSON.stringify(payload),
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();

            // 분리: 거래대금 증감% 있는 항목 / 금일 등락% 있는 항목
            const tradingRows = (data || []).filter(r => r.trading_value_change_pct !== null && r.trading_value_change_pct !== undefined);
            const changeRows   = (data || []).filter(r => r.today_price_change_pct   !== null && r.today_price_change_pct   !== undefined);

            renderTradingTable(tradingRows);
            renderChangeTable(changeRows);
        } catch (e) {
            console.error(e);
            alert('데이터를 불러오지 못했습니다.');
        }

        /*if (!yyyymmdd || today_yyyymmdd !== yyyymmdd) {
            clearInterval(timer);
            clearInterval(timer2);
            return;
        }*/

        startTimer();
    }

    function startTimer() {
        if (timer) clearInterval(timer);
        if (timer2) clearInterval(timer2);

        timer = setInterval(()=>{
            const input = document.getElementById('dateInput');
            const yyyymmdd = input.value?.replace(/-/g, '');
            // if (!yyyymmdd || today_yyyymmdd !== yyyymmdd) return;
            const stock_names = document.querySelectorAll('.stock_name'); // 탭 1
            stock_names.forEach(i=>s.add((i.textContent)));

            const stocks = Array.from(s);

            stocks.forEach(stock_name=>{
                // console.log('ss', stock_name)
                const data = {
                    stock_name: stock_name,
                }
                axios.post("/func/stocks/info", data, {
                    headers: {"Content-Type": "application/json"},
                    timeout: 3000 // 3초 초과시 자동 reject
                }).then(async res => {
                    const stock_data = res.data.result[0]?.data.items[0];
                    const stock_name = stock_data?.productName;
                    const product_code = stock_data?.productCode;
                    p.add(product_code);
                    const logo_url = stock_data?.logoImageUrl;
                    const realtime_price = stock_data?.close.krw;

                    for (const i of stock_names) {
                        if (i.textContent === stock_name) {
                            const tr = i.closest('tr');
                            i.previousElementSibling.value = product_code;
                            const yesterday_close_el = tr.querySelector('.yst_close');
                            const current_price_el = tr.querySelector('.cur_close');
                            const price_change_pct_el = tr.querySelector('.prc_change');
                            const calc_change_pct = (current_price_el.textContent.replace(/[^0-9.]/g, '') - yesterday_close_el.textContent.replace(/[^0-9.]/g, ''))
                                / yesterday_close_el.textContent.replace(/[^0-9.]/g, '') * 100;
                            await updateTdWithBlink(current_price_el, fmt2(realtime_price) + '원');
                            await updateTdWithBlink(price_change_pct_el, fmt2(calc_change_pct) + '%');
                        }
                    }


                }).catch(error => {
                    throw error; // 기타 에러는 그대로 던짐
                });
            })
        }, 2000)

        timer2 = setInterval(()=>{
            const productCodes = Array.from(p);
            productCodes.forEach(productCode => {
                // console.log('p', productCode)
                if (productCode) {
                    const data = {
                        product_code: productCode
                    }
                    axios.post("/func/stocks/amount", data, {
                        headers: {"Content-Type": "application/json"},
                        timeout: 3000 // 3초 초과시 자동 reject
                    }).then(async res => {
                        const amount = res.data.result.candles[0].amount;
                        const product_codes = document.querySelectorAll('.product_code');

                        for (const p1 of product_codes) {
                            if (p1.value === productCode) {
                                const tr = p1.closest('tr');
                                const yesterday_amount = tr.querySelector('.avg_amount').dataset.avg5dAmount;
                                const amount_change_pct = Number(amount) / Number(yesterday_amount.replace(/[^0-9.]/g, "")) * 100
                                const current_amount_el = tr.querySelector('.cur_amount');
                                const amount_change_pct_el = tr.querySelector('.tv_change');
                                await updateTdWithBlink(current_amount_el, fmt_won(amount));
                                await updateTdWithBlink(amount_change_pct_el, fmt2(amount_change_pct) + '%');
                            }
                        }
                    }).catch(error => {
                        throw error; // 기타 에러는 그대로 던짐
                    });
                }
            })
        }, 1000 * 10)
    }

    function stopTimer(timer) {
        clearInterval(timer);
        timer = null;
    }

    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) { // 다시 브라우저를 방문하면 한 번만 실행된다
            startTimer();
        } else { // 창을 나가면
            stopTimer(timer);
            stopTimer(timer2);
        }
    })

    // 날짜 변경 시 즉시 불러오기
    document.getElementById('dateInput').addEventListener('change', loadData);

    // 첫 진입 시 현재 날짜로 자동 로드
    window.addEventListener('DOMContentLoaded', loadData);
</script>

</body>
</html>
