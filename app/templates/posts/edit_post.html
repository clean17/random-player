<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>ê²Œì‹œê¸€ ìˆ˜ì •</title>
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
    <link rel="stylesheet" href="/static/css/style.css?v={{ version }}">
    <link rel="stylesheet" href="/static/css/post.css?v={{ version }}">
</head>
<body>
<!--<div class="top-bar">
    <div class="logout">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">Logout</a>
        {% endif %}
    </div>
    <div class="back">
        <a href="{{ url_for('main.home') }}">Back</a>
    </div>
</div>-->

<form class="container" id="post-form" action="{% if type == 'C' %}/posts/create{% elif type == 'U' %}/posts/{{ post_id }}/edit{% endif %}"
      method="post">
    <div class="form-group">
        <div class="post-info">
            <div class="edit-post-title">
                <input type="text" name="title" id="title" value="{{ post.title if post else ''}}" required placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
        </div>
    </div>
    <!--<div class="form-group">
        <label for="content">ì²¨ë¶€</label>
        <input type="file" name="file" id="file"/>
    </div>-->
    <div class="form-group textarea-wrapper">
<!--        <textarea name="content" id="content" required placeholder="Enter the contents">{{ post.content if post else ''}}</textarea>-->
        <div id="editor"></div>
        <input type="hidden" name="content" id="content-input">
    </div>
    <div class="form-actions">
        {% if post %}
        <a href="/posts/{{ post.id }}">
            <button type="button" class="btn btn-secondary">ë‚˜ê°€ê¸°</button>
        </a>
        {% else %}
        <a href="/posts/">
            <button type="button" class="btn btn-secondary">ë‚˜ê°€ê¸°</button>
        </a>
        {% endif %}
        <button type="submit" class="btn btn-main">
            {% if type == 'C' %}ë“±ë¡{% elif type == 'U' %}ìˆ˜ì •ì™„ë£Œ{% endif %}
        </button>
        <button type="button" class="btn-secondary" onclick="window.location.href='/posts'">ëª©ë¡ìœ¼ë¡œ</button>
    </div>
</form>
</body>
<script>
    const form = document.getElementById('post-form');
    const contentInput = document.getElementById('content-input');
    const toolbarOptions = [
        [{ 'header': [1, 2, 3, false] }],              // <h1>, <h2>, <h3>, ê¸°ë³¸
        ['bold', 'italic', 'underline', 'strike'],     // êµµê²Œ, ê¸°ìš¸ì„, ë°‘ì¤„, ì·¨ì†Œì„ 
        [{ 'color': [] }, { 'background': [] }],       // ê¸€ììƒ‰, ë°°ê²½ìƒ‰
        [{ 'list': 'ordered' }, { 'list': 'bullet' }], // ë²ˆí˜¸ ë§¤ê²¨ì§„ ëª©ë¡ (1. 2. 3.â€¦), ì  ëª©ë¡ (â€¢ â€¢ â€¢)
        ['link', 'image', /*'video'*/],                    // í•˜ì´í¼ë§í¬, ì´ë¯¸ì§€, ë¹„ë””ì˜¤
        ['clean']                                      // í¬ë§· ì œê±° ë²„íŠ¼ (Clear formatting) > ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¡œ
    ];
    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...',
        modules: {
            toolbar: {
                container: toolbarOptions,
                handlers: {
                    image: imageHandler,
                    // video: videoHandler
                }
            }
        }
    });


    // ----------------------------
    // ğŸ”¥ ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ì´ˆê¸°ê°’ ì±„ìš°ê¸°
    // ----------------------------
    {% if type == 'U' and post %}
    const html = {{ post.content|tojson|safe }};
    quill.root.innerHTML = html;
    {% endif %}

    form.addEventListener('submit', function () {
        // 1) HTMLë¡œ ì €ì¥í•˜ê³  ì‹¶ìœ¼ë©´:
        contentInput.value = quill.root.innerHTML;

        // 2) Delta(JSON)ìœ¼ë¡œ ì €ì¥í•˜ê³  ì‹¶ìœ¼ë©´:
        // contentInput.value = JSON.stringify(quill.getContents());
    });

    // Quill ì´ˆê¸°í™” ë’¤ìª½ì— ë¶™ì´ë©´ ë¨
    quill.root.addEventListener('paste', async (e) => {
        const clipboardData = e.clipboardData || window.clipboardData;
        if (!clipboardData) return;

        const imageFiles = [];

        // 1) filesì— ì´ë¯¸ì§€ê°€ ì—¬ëŸ¬ ê°œ ë“¤ì–´ì˜¨ ê²½ìš° (íƒìƒ‰ê¸°ì—ì„œ íŒŒì¼ ë³µì‚¬ ë“±)
        if (clipboardData.files && clipboardData.files.length > 0) {
            for (let i = 0; i < clipboardData.files.length; i++) {
                const file = clipboardData.files[i];
                if (file.type && file.type.startsWith('image/')) {
                    imageFiles.push(file);
                }
            }
        } else {
            // 2) filesê°€ ë¹„ì–´ìˆì„ ë•Œë§Œ itemsì—ì„œ ì´ë¯¸ì§€ ì°¾ê¸° (ìº¡ì²˜/ê·¸ë¦¼íŒ ë“±)
            const items = clipboardData.items;
            if (items && items.length > 0) {
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) imageFiles.push(file);
                    }
                }
            }
        }

        // ì´ë¯¸ì§€ê°€ ì•„ì˜ˆ ì—†ìœ¼ë©´ ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ê·¸ëŒ€ë¡œ
        if (imageFiles.length === 0) return;

        // ì´ë¯¸ì§€ ìˆìœ¼ë©´ Quill ê¸°ë³¸ paste ë™ì‘ ë§‰ê³  ìš°ë¦¬ê°€ ì²˜ë¦¬
        e.preventDefault();

        let range = quill.getSelection(true);
        if (!range) {
            range = { index: quill.getLength(), length: 0 };
        }

        // /uploadëŠ” í•œ ë²ˆì— í•˜ë‚˜ì”©
        for (const file of imageFiles) {
            const imageUrl = await uploadImage(file);
            if (!imageUrl) continue;

            quill.insertEmbed(range.index, 'image', imageUrl);
            range.index += 1;
            quill.setSelection(range.index);
        }
    });
;
;


    async function uploadImage(file) {
        if (!file) return null;

        const formData = new FormData();
        formData.append('files[]', file);

        const res = await fetch('/upload', {
            method: 'POST',
            body: formData
        });

        if (!res.ok) {
            alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨');
            return null;
        }

        const data = await res.json();
        // ì„œë²„ì—ì„œ ì—¬ëŸ¬ íŒŒì¼ì„ ëŒë ¤ì¤¬ë‹¤ë©´ ì²« ë²ˆì§¸ ê²ƒë§Œ ì“´ë‹¤ê³  ê°€ì •
        const first = data.files && data.files[0];
        return first ? first.url : null;
    }

    function imageHandler() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = async () => {
            const file = input.files[0];
            if (!file) return;

            const imageUrl = await uploadImage(file);
            if (!imageUrl) return;

            const range = quill.getSelection(true) || { index: quill.getLength(), length: 0 };
            quill.insertEmbed(range.index, 'image', imageUrl);
            quill.setSelection(range.index + 1);
        };
    }



    /*function videoHandler() {
        const url = prompt('ë¹„ë””ì˜¤ URLì„ ì…ë ¥í•˜ì„¸ìš” (https ê¶Œì¥):');
        if (!url) return;

        if (!url.startsWith('https://')) {
            alert('https ì£¼ì†Œë§Œ ì•ˆì „í•˜ê²Œ ì¬ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. httpëŠ” ë§í¬ë¡œë§Œ ì¶”ê°€í• ê²Œìš”.');
            const range = this.quill.getSelection(true);
            this.quill.insertText(range.index, url, { link: url });
            this.quill.setSelection(range.index + url.length);
            return;
        }

        const range = this.quill.getSelection(true);
        this.quill.insertEmbed(range.index, 'customVideo', url);
        this.quill.setSelection(range.index + 1);
    }*/
</script>
</html>
