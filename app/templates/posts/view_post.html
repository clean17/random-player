<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>{{ post.title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://unpkg.com/quill-markdown-shortcuts/dist/quill.markdown-shortcuts.js"></script>
    <script src="/static/js/common.js?v={{ version }}"></script>
    <link rel="stylesheet" href="/static/css/style.css?v={{ version }}">
    <link rel="stylesheet" href="/static/css/post.css?v={{ version }}">
</head>
<body>
<!--<div class="top-bar">
    <div class="logout">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">Logout</a>
        {% endif %}
    </div>
    <div class="back">
        <a href="{{ url_for('main.home') }}">Back</a>
    </div>
</div>-->

<div class="container">
    <div class="form-group">
        <div class="post-info">
            <div class="view-post-title">{{ post.title }}</div>
            <div class="post-meta">{{ post.realname or '이름 없음' }} &nbsp;|&nbsp; {{ post.updated_at }}</div>
        </div>
    </div>
    <hr>
    <!--<div class="form-group">
        <label for="content">첨부</label>
        <input type="file" name="file" id="file"/>
    </div>-->
    <div class="form-group textarea-wrapper">
        <div class="post-content-wrapper">
            <button type="button" class="copy-btn" id="copy-post-text">내용 복사</button>
<!--        <pre name="content" id="content" readonly>{{ post.content or ''}}</pre>-->
            <div class="post-content ql-editor">{{ post.content|safe }}</div>
        </div>

    </div>
    <div class="form-actions">
        {% if post.user_id == user.id %}
        <button type="button" class="btn btn-danger" id="delete-post">삭제</button>
        <button type="submit" class="btn btn-main" onclick="window.location.href='/posts/{{ post.id }}/edit'">수정</button>
        {% endif %}
        <button type="button" class="btn-secondary" onclick="window.location.href='/posts'">목록으로</button>
    </div>
</div>
</body>
<script>
    const deletePostBtn = document.getElementById('delete-post');
    const copyBtn = document.getElementById('copy-post-text');
    const editor = document.querySelector('.post-content.ql-editor');


    /**
     * 텍스트를 줄 단위로 보고, 인덴트 깊이(레벨)는 유지하면서 들여쓰기를 4칸 스페이스로 통일
     *
     * text.split('\n')
     *   → 줄 단위로 나눔
     * indents 계산
     *   빈 줄 제외
     *   각 줄의 맨 앞 연속 스페이스 길이를 수집
     *   예: " def" → 2, " super" → 4
     * unit / baseUnit 결정
     *   unit = 최소 인덴트 길이
     *   보통 DB가 &nbsp;&nbsp; 기반이면 최소가 2가 나오고, 코드가 원래 2칸 단위였다고 “추정”
     *   baseUnit을 2 또는 4 중 하나로 잡아서 “레벨” 계산 기준으로 삼음
     * 각 줄에 대해
     *   \t(탭)가 있으면 ' ' 4칸으로 교체
     *   앞 스페이스 길이 n을 구함
     *   level = round(n / baseUnit)
     *     → “원래 몇 단계 들여쓰기였는지”로 환산
     *   fixed = level * 4
     *     → 그 레벨을 4칸 들여쓰기 기준으로 다시 만들기
     *   앞 공백을 ' '.repeat(fixed) 로 교체
     * */
    function normalizeIndentTo4(text) {
        const lines = text.split('\n');

        // 1) 유효한(비어있지 않은) 라인들에서 "최소 인덴트 단위" 감지
        const indents = lines
            .filter(l => l.trim().length > 0)
            .map(l => (l.match(/^[ ]+/)?.[0].length ?? 0))
            .filter(n => n > 0);

        // 보통 DB는 2칸(&nbsp;&nbsp;) 단위가 많음
        // 최소 인덴트가 2면 2->4로 스케일, 4면 그대로
        const unit = indents.length ? Math.min(...indents) : 4;
        const baseUnit = (unit === 2 || unit === 4) ? unit : (unit % 4 === 0 ? 4 : 2);

        return lines.map(line => {
            // 탭이 혹시 있으면 4칸으로
            line = line.replace(/\t/g, '    ');

            const m = line.match(/^[ ]+/);
            if (!m) return line;

            const n = m[0].length;
            const level = Math.round(n / baseUnit);     // 원래 레벨
            const fixed = level * 4;                    // 4칸 인덴트로 환산

            return ' '.repeat(fixed) + line.slice(n);
        }).join('\n');
    }

    function htmlToPlainCode(html) {
        if (!html) return '';

        // p/br -> 줄바꿈
        let s = html
            .replace(/<br\s*\/?>/gi, '\n')
            .replace(/<\/p\s*>/gi, '\n')
            .replace(/<p[^>]*>/gi, '');

        // 엔티티 디코딩 (&nbsp; -> NBSP 등)
        s = decodeHtmlEntities(s);

        // 유니코드 공백 전부 ASCII 스페이스로 강제
        s = forceAsciiSpaces(s);

        // 줄바꿈 통일 + 과한 공백줄 정리
        s = s
            .replace(/\r\n/g, '\n')
            .replace(/\r/g, '\n')
            .replace(/[ \t]+\n/g, '\n')   // 줄 끝 공백 제거
            // .replace(/\n{3,}/g, '\n\n')   // 3줄 이상은 2줄로
            .trimEnd();

        // 인덴트를 "레벨 유지 + 4칸"으로 정규화
        s = normalizeIndentTo4(s);

        return s;
    }


    function initPage() {
        if (editor) {
            editor.setAttribute('contenteditable', 'false');
        }

        deletePostBtn?.addEventListener('click', () => {
            if (confirm('삭제하시겠습니까?')) {
                axios.post("/posts/{{ post.id }}/del", {}, {
                    headers: {"Content-Type": "application/json"},
                    timeout: 3000 // 3초 초과시 자동 reject
                }).then(async res => {
                    if ("true" === res.data.result) {
                        window.location.replace("/posts");
                    }
                }).catch(error => {
                    throw error; // 기타 에러는 그대로 던짐
                });
            }
        })

        copyBtn?.addEventListener('click', async () => {
            // editor가 HTML을 갖고 있는 경우 (DB 원본을 editor.innerHTML로 넣었다면)
            const html = editor.innerHTML || editor.innerText || editor.textContent || '';
            const text = htmlToPlainCode(html);
            /*text = text.trim();

            const imgs = editor.querySelectorAll('img');
            const imgUrls = Array.from(imgs).map(img => img.src);

            if (imgUrls.length > 0) {
                text += '\n\n[이미지]\n' + imgUrls.map(url => `![](${url})`).join('\n');
            }*/

            if (!text.trim()) {
                showDebugToast('복사할 내용이 없습니다.');
                return;
            }

            try {
                await navigator.clipboard.writeText(text);
                copyBtn.textContent = '복사됨!';
                setTimeout(() => (copyBtn.textContent = '내용 복사'), 1000);
            } catch (err) {
                console.error(err);
                showDebugToast('복사에 실패했습니다.');
            }
        });

    }

    document.addEventListener("DOMContentLoaded", initPage);
</script>
</html>
