<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>{{ post.title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://unpkg.com/quill-markdown-shortcuts/dist/quill.markdown-shortcuts.js"></script>
    <script src="/static/js/common.js?v={{ version }}"></script>
    <link rel="stylesheet" href="/static/css/style.css?v={{ version }}">
    <link rel="stylesheet" href="/static/css/post.css?v={{ version }}">
</head>
<body>
<!--<div class="top-bar">
    <div class="logout">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">Logout</a>
        {% endif %}
    </div>
    <div class="back">
        <a href="{{ url_for('main.home') }}">Back</a>
    </div>
</div>-->

<div class="container">
    <div class="form-group">
        <div class="post-info">
            <div class="view-post-title">{{ post.title }}</div>
            <div class="post-meta">{{ post.realname or '이름 없음' }} &nbsp;|&nbsp; {{ post.updated_at }}</div>
        </div>
    </div>
    <hr>
    <!--<div class="form-group">
        <label for="content">첨부</label>
        <input type="file" name="file" id="file"/>
    </div>-->
    <div class="form-group textarea-wrapper">
        <div class="post-content-wrapper">
            <button type="button" class="copy-btn" id="copy-post-text">내용 복사</button>
<!--        <pre name="content" id="content" readonly>{{ post.content or ''}}</pre>-->
            <div class="post-content ql-editor">{{ post.content|safe }}</div>
        </div>

    </div>
    <div class="form-actions">
        {% if post.user_id == user.id %}
        <button type="button" class="btn btn-danger" id="delete-post">삭제</button>
        <button type="submit" class="btn btn-main" onclick="window.location.href='/posts/{{ post.id }}/edit'">수정</button>
        {% endif %}
        <button type="button" class="btn-secondary" onclick="window.location.href='/posts'">목록으로</button>
    </div>
</div>
</body>
<script>
    const deletePostBtn = document.getElementById('delete-post');
    const copyBtn = document.getElementById('copy-post-text');
    const editor = document.querySelector('.post-content.ql-editor');

    function htmlToPlainCode(html) {
        if (!html) return '';

        // 1) 줄바꿈이 될 태그를 먼저 \n으로 바꿔둠
        let s = html
            .replace(/<br\s*\/?>/gi, '\n')
            .replace(/<\/p\s*>/gi, '\n')
            .replace(/<p[^>]*>/gi, ''); // <p> 시작태그 제거

        // 2) HTML 엔티티 해제( &nbsp; 등 )
        //    브라우저에 맡기는 방식이 가장 안전함
        const ta = document.createElement('textarea');
        ta.innerHTML = s;
        s = ta.value;

        // 3) NBSP/제로폭 문자 정리
        s = s
            .replace(/\u00A0/g, ' ')   // NBSP -> space
            .replace(/\u200B/g, '')    // zero-width space 제거
            .replace(/\r\n/g, '\n')
            .replace(/\r/g, '\n');

        // 4) 불필요한 공백 줄 정리(원하면 조절)
        s = s.replace(/\n{3,}/g, '\n\n');

        // 5) 끝부분 정리
        return s.trimEnd();
    }


    function initPage() {
        if (editor) {
            editor.setAttribute('contenteditable', 'false');
        }

        deletePostBtn?.addEventListener('click', () => {
            if (confirm('삭제하시겠습니까?')) {
                axios.post("/posts/{{ post.id }}/del", {}, {
                    headers: {"Content-Type": "application/json"},
                    timeout: 3000 // 3초 초과시 자동 reject
                }).then(async res => {
                    if ("true" === res.data.result) {
                        window.location.replace("/posts");
                    }
                }).catch(error => {
                    throw error; // 기타 에러는 그대로 던짐
                });
            }
        })

        copyBtn?.addEventListener('click', async () => {
            // editor가 HTML을 갖고 있는 경우 (DB 원본을 editor.innerHTML로 넣었다면)
            const html = editor.innerHTML || '';
            const text = htmlToPlainCode(html);

            if (!text.trim()) {
                showDebugToast('복사할 내용이 없습니다.');
                return;
            }

            try {
                await navigator.clipboard.writeText(text);
                copyBtn.textContent = '복사됨!';
                setTimeout(() => (copyBtn.textContent = '내용 복사'), 1000);
            } catch (err) {
                console.error(err);
                showDebugToast('복사에 실패했습니다.');
            }
        });

    }

    document.addEventListener("DOMContentLoaded", initPage);
</script>
</html>
