<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>{{ post.title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://unpkg.com/quill-markdown-shortcuts/dist/quill.markdown-shortcuts.js"></script>
    <script src="/static/js/common.js?v={{ version }}"></script>
    <link rel="stylesheet" href="/static/css/style.css?v={{ version }}">
    <link rel="stylesheet" href="/static/css/post.css?v={{ version }}">
</head>
<body>
<!--<div class="top-bar">
    <div class="logout">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">Logout</a>
        {% endif %}
    </div>
    <div class="back">
        <a href="{{ url_for('main.home') }}">Back</a>
    </div>
</div>-->

<div class="container">
    <div class="form-group">
        <div class="post-info">
            <div class="view-post-title">{{ post.title }}</div>
            <div class="post-meta">{{ post.realname or '이름 없음' }} &nbsp;|&nbsp; {{ post.updated_at }}</div>
        </div>
    </div>
    <hr>
    <!--<div class="form-group">
        <label for="content">첨부</label>
        <input type="file" name="file" id="file"/>
    </div>-->
    <div class="form-group textarea-wrapper">
        <div class="post-content-wrapper">
            <button type="button" class="copy-btn" id="copy-post-text">내용 복사</button>
<!--        <pre name="content" id="content" readonly>{{ post.content or ''}}</pre>-->
            <div class="post-content ql-editor">{{ post.content|safe }}</div>
        </div>

    </div>
    <div class="form-actions">
        {% if post.user_id == user.id %}
        <button type="button" class="btn btn-danger" id="delete-post">삭제</button>
        <button type="submit" class="btn btn-main" onclick="window.location.href='/posts/{{ post.id }}/edit'">수정</button>
        {% endif %}
        <button type="button" class="btn-secondary" onclick="window.location.href='/posts'">목록으로</button>
    </div>
</div>
</body>
<script>
    const deletePostBtn = document.getElementById('delete-post');
    const copyBtn = document.getElementById('copy-post-text');
    const editor = document.querySelector('.post-content.ql-editor');

    function initPage() {
        if (editor) {
            editor.setAttribute('contenteditable', 'false');
        }

        deletePostBtn?.addEventListener('click', () => {
            if (confirm('삭제하시겠습니까?')) {
                axios.post("/posts/{{ post.id }}/del", {}, {
                    headers: {"Content-Type": "application/json"},
                    timeout: 3000 // 3초 초과시 자동 reject
                }).then(async res => {
                    if ("true" === res.data.result) {
                        window.location.replace("/posts");
                    }
                }).catch(error => {
                    throw error; // 기타 에러는 그대로 던짐
                });
            }
        })

        copyBtn?.addEventListener('click', async function () {
            let text = editor.innerText || editor.textContent || '';

            // 1) 윈도우/맥 섞여 있을 수 있으니 \r\n, \r 를 \n으로 통일
            // text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

            // 2) 연속 개행 두 개 이상 → 하나로 줄이기 (원하는 경우만)
            // text = text.replace(/\n{2,}/g, '\n');

            /*text = text.trim();

            const imgs = editor.querySelectorAll('img');
            const imgUrls = Array.from(imgs).map(img => img.src);

            if (imgUrls.length > 0) {
                text += '\n\n[이미지]\n' + imgUrls.map(url => `![](${url})`).join('\n');
            }*/

            if (!text.trim()) {
                showDebugToast('복사할 내용이 없습니다.');
                return;
            }

            try {
                await navigator.clipboard.writeText(text);
                // 살짝 피드백
                copyBtn.textContent = '복사됨!';
                setTimeout(() => copyBtn.textContent = '내용 복사', 1000);
            } catch (err) {
                console.error(err);
                showDebugToast('복사에 실패했습니다.');
            }
        });
    }

    document.addEventListener("DOMContentLoaded", initPage);
</script>
</html>
