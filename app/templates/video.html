<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Video Player</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/video.css') }}">
    <link href="//vjs.zencdn.net/8.3.0/video-js.min.css" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/video.js') }}"></script>
    <script src="//vjs.zencdn.net/8.3.0/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<style>
    .video-mirror {
        width: 33.33%;
        height: auto;
        object-fit: cover;
    }
</style>
<body>
    <div class="top-bar">
        <div class="back">
            <a href="{{ url_for('main.home') }}">Back</a>
        </div>
        <div class="logout">
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('auth.logout') }}">Logout</a>
            {% endif %}
        </div>
    </div>
    <div id="videoContainer">
        <video id="videoPlayer" class="video-js vjs-default-skin" controls preload="auto">
            <source src="" type="video/mp4">
        </video>
        <div id="controls">
            <button id="deleteButton">Delete</button>
            <button id="nextButton">Next</button>
        </div>
    </div>
    <div id="sync-message"></div>
    <div id="volume-message"></div>

    <script>
        let player;
        let videoElement;
        let currentVideo = '';
        let controls = document.querySelector('#controls');
        let topDiv = document.querySelector('.top-bar');
        let directory = "{{ directory }}";
        let videoPlayer = document.querySelector('#videoPlayer');
        let audioOffset = 0;
        let syncMessage = document.getElementById('sync-message');
        let volumeMessage = document.getElementById('volume-message');
        let videoLeft;
        let videoRight;
        {#var videoElement = document.getElementById('my-video_html5_api'); // 직접 비디오 엘리먼트 선택#}
        let hideControlsTimeout;


        function getVideo() {
            axios.get(`/video/videos?directory=${directory}`)
                .then(response => {
                    let videos = response.data;
                    if (videos.length > 0) {
                        currentVideo = videos[0];
                        let url = directory === '0' ? `/video/stream/` : `/video/video/`;
                        let videoUrl = url + `${encodeURIComponent(currentVideo)}?directory=${directory}`;
                        let fileExtension = currentVideo.split('.').pop();
                        let mimeType = fileExtension === 'ts' ? 'video/mp2t' : 'video/mp4';
                        videoPlayer.querySelector('source').src = videoUrl;
                        document.title = currentVideo.replace(/.\\/g,'')
                        player = videojs('videoPlayer', setVideoOptions(videoUrl, mimeType));
                        player.src({ type: mimeType, src: videoUrl });
                        player.load();
                        player.on('loadeddata', function() {
                            player.play();
                            // TODO videojs 속성이 이전 영상 데이터를 가져오는것 같다
                            addKeyboardControls();
                        });
                        player.on('loadedmetadata', function() {
                            //threeSplitLayout();
                        });
                    } else {
                        alert('No videos found');
                    }
                });
        }

        function initPage() {
            // player = videojs('videoPlayer');
            getVideo();
        }

        document.addEventListener("DOMContentLoaded", initPage)
    </script>
</body>
</html>
