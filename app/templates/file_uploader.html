<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uppy Upload</title>

    <link rel="stylesheet" href="/static/css/style.css?v={{ version }}">
    <link rel="stylesheet" href="/static/css/home.css?v={{ version }}">
    <link rel="stylesheet" href="/static/css/uppy.css">

    <script src="/static/js/uppy/uppy.min.js"></script>
    <script src="/static/js/common.js?v={{ version }}"></script>

    <!--    <link href="https://releases.transloadit.com/uppy/v4.12.2/uppy.min.css" rel="stylesheet">-->
    <!--    <script src="https://releases.transloadit.com/uppy/v4.12.2/uppy.min.js"></script>-->
    <style>
        .uppy-Dashboard-inner {
            background-color: #f8f8f8;
        }

        /* í† ìŠ¤íŠ¸ë¡œ ë³€ê²½ */
        /*.save-message {
            top: 35%;
            right: 47%;
        }*/
    </style>
</head>
<body>
<div class="top-bar">
    <div class="logout">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">Logout</a>
        {% endif %}
    </div>
    <div class="back">
        <a href="{{ url_for('main.home') }}">Back</a>
    </div>
</div>

<div class="container">
    <h2>Upload File</h2>
    <!--<input type="text" id="title" name="title" placeholder="Enter Title" class="input-size" autocomplete="off">
    <select id="title-select" name="title" onchange="enterTitle()" class="input-size">
        <option value="">ì œëª© ì—†ìŒ</option>
        {% for title in title_list %}
        <option value="{{ title }}">{{ title }}</option>
        {% endfor %}
    </select>
    <div id="uppy-dashboard" style="background-color: white"></div>
    <button id="start-upload-button" style="margin-top: 10px" class="btn-w100">Start Upload</button>-->

    <form id="uploadForm" enctype="multipart/form-data">
        <input type="text" id="title" name="title" placeholder="Enter Title" class="input-size" autocomplete="off">
        <select id="title-select" name="title" onchange="enterTitle()" class="input-size">
            <option value="">ì œëª© ì—†ìŒ</option>
            {% for title in title_list %}
            <option value="{{ title }}">{{ title }}</option>
            {% endfor %}
        </select>
        <input type="file" name="files[]" multiple style="margin-bottom: 10px" id="fileInput" class="input-size">
        <button type="submit" class="btn-w100">Start Upload</button>
    </form>

    <!-- ì§„í–‰ë¥  í‘œì‹œ ì˜ì—­ -->
    <div id="progressContainer" style="margin-top: 10px; display: none;">
        <progress id="progressBar" value="0" max="100" style="width: 300px;"></progress>
        <span id="percentText">0%</span>
    </div>
    <div id="save-message" class="save-message">âœ” ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>
</div>
<script>
    const screenHeight = window.innerHeight,
          containerHeight = document.querySelector('.container').scrollHeight,
          uploadBatchSize = 20,
          uploadForm = document.getElementById('uploadForm'),
          previous_title = `{{ previous_title }}`,
          titleSelect = document.getElementById('title-select'),
          titleInput = document.getElementById('title');
    let currentBatchIndex = 0,
        submitted = false;


    // ê³µí†µ //
    /*function showMessagePopup(text = 'ê¸°ë³¸ë©”ì„¸ì§€', state = 'success') {
        let message = document.getElementById("save-message");
        message.textContent = text;
        message.style.display = "block";  // ë©”ì‹œì§€ í‘œì‹œ
        if (state === 'success') {
            message.style.background = 'rgba(0, 128, 0, 0.5)';
        } else if (state === 'fail') {
            message.style.background = 'rgba(255, 0, 0, 0.6)';
        }
        setTimeout(() => {
            message.style.display = "none";  // 2ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¹€
        }, 2000);
    }*/

    function enterTitle() {
        titleInput.value = titleSelect.value;
    }


    // UPPY //
    /*const uppy = new Uppy.Uppy({
        debug: false,
        autoProceed: false, // íŒŒì¼ ì¶”ê°€ ì‹œ ìë™ìœ¼ë¡œ ì—…ë¡œë“œ ì§„í–‰
        restrictions: {
            maxFileSize: 40000000000, // 40GB
            maxNumberOfFiles: 100,
            minNumberOfFiles: 1,
        },
    })
        .use(Uppy.Dashboard, {
            target: '#uppy-dashboard',
            inline: true,
            // width: 600,
            height: screenHeight-containerHeight,
            showProgressDetails: true,
            hideUploadButton: true,
            // note: 'Maximum number of upload files limited: 5000',
        })
        .use(Uppy.Webcam, {
            modes: ['video-audio', 'video-only', 'audio-only', 'picture'], // ì‚¬ìš©í•  ëª¨ë“œ ì§€ì •
            countdown: false, // ì‚¬ì§„ ì´¬ì˜ ì „ì— ì¹´ìš´íŠ¸ë‹¤ìš´ ë¹„í™œì„±í™”
            mirror: true, // ë¯¸ëŸ¬ë§ í™œì„±í™”
        })
        .use(Uppy.GoogleDrive, {
            companionUrl: 'https://companion.uppy.io', // Companion ì„œë²„ URL
        })
        .use(Uppy.GooglePhotos, {
            companionUrl: 'https://companion.uppy.io', // Companion ì„œë²„ URL
        })
        .use(Uppy.XHRUpload, {
            endpoint: '/upload/',
            fieldName: 'files[]',
            bundle: true,
            limit: 5, // í•œë²ˆì— ì—…ë¡œë“œ ê°€ëŠ¥í•œ íŒŒì¼ìˆ˜ëŸ‰ ì œí•œ
        });
    /!*.use(Uppy.Tus, { # ì„œë²„ê°€ Tusë¥¼ ì§€ì›í•´ì•¼ í•œë‹¤.. êµ¬í˜„ì´ í•„ìš”
        endpoint: '/upload/', // Tus ì„œë²„ ì—”ë“œí¬ì¸íŠ¸
        chunkSize: 5 * 1024 * 1024, // ì²­í¬ í¬ê¸° (5MB)
        retryDelays: [0, 1000, 3000, 5000], // ì¬ì‹œë„ ì§€ì—° ì‹œê°„
    })*!/

    uppy.on('complete', (result) => {
        document.querySelector('.container h2').textContent = `Upload File`
    });

    function uploadNextBatch(allFiles) {
        // íŒŒì¼ì´ ìœ íš¨í•˜ì§€ ì•Šì„ ê²½ìš° ì²˜ë¦¬
        if (!Array.isArray(allFiles) || allFiles.length === 0) {
            console.error('No files to upload or invalid file list');
            alert('No valid files to upload!');
            return;
        }

        const totalBatches = Math.ceil(allFiles.length / uploadBatchSize);

        if (currentBatchIndex >= totalBatches) {
            console.log('All batches uploaded successfully!');
            return;
        }

        // í˜„ì¬ ë°°ì¹˜ ê³„ì‚°
        const batchStart = currentBatchIndex * uploadBatchSize;
        const batchEnd = Math.min(batchStart + uploadBatchSize, allFiles.length);
        const currentBatch = allFiles.slice(batchStart, batchEnd);

        // console.log(`Uploading batch ${currentBatchIndex + 1} of ${totalBatches}`, currentBatch);
        document.querySelector('.container h2').textContent = `Upload File [ ${currentBatchIndex + 1} / ${totalBatches} ]`

        // ê¸°ì¡´ ëŒ€ê¸°ì—´ì—ì„œ ëª¨ë“  íŒŒì¼ ì œê±°
        uppy.getFiles().forEach((file) => {
            uppy.removeFile(file.id);
        });

        // í˜„ì¬ ë°°ì¹˜ì˜ íŒŒì¼ ì¶”ê°€
        currentBatch.forEach((file) => {
            uppy.addFile(file);
        });

        // í˜„ì¬ ë°°ì¹˜ ì—…ë¡œë“œ
        uppy.upload().then((result) => {
            console.log(`Batch ${currentBatchIndex + 1} uploaded successfully!`, result);
            currentBatchIndex++;
            uploadNextBatch(allFiles); // ë‹¤ìŒ ë°°ì¹˜ ì—…ë¡œë“œ
        }).catch((error) => {
            console.error('Error uploading batch:', error);
        });
    }

    document.getElementById('start-upload-button').addEventListener('click', () => {
        const title = titleInput.value || 'no_title';
        uppy.setMeta({ title: title });
        const allFiles = uppy.getFiles();
        if (!Array.isArray(allFiles) || allFiles.length === 0) {
            alert('No files to upload!');
            return;
        }
        currentBatchIndex = 0;
        uploadNextBatch(allFiles);
    });*/



    // ê¸°ë³¸ ì—…ë¡œë“œ //
    // ë³€ê²½ì„ ê°ì§€í•˜ëŠ” ì´ë²¤íŠ¸ê°€ ìë°”ìŠ¤í¬ë¦½íŠ¸ì— ì—†ì–´..
    /*document.getElementById('fileInput').addEventListener('change', function () {
        if (!document.getElementById('overlay')) {
            const overlay = document.createElement('div');
            overlay.id = 'overlay';
            overlay.style.display = 'none';
            overlay.innerHTML = '<img src="/static/overlay-loading.svg" alt="Loading...">';
            const container = document.querySelector('.container');
            document.body.appendChild(overlay);
        }

        document.getElementById('overlay').style.display = 'block';
        document.body.style.pointerEvents = "none"; // í™”ë©´ ì´ë²¤íŠ¸ ì œê±°

        document.getElementById('overlay').style.display = 'none';
        document.body.style.pointerEvents = "auto"; // í™”ë©´ ì´ë²¤íŠ¸ ë³µì›
    });*/


    document.addEventListener('DOMContentLoaded', () => {
        if (previous_title && previous_title !== 'None') {
            titleSelect.value = previous_title;
            titleInput.value = previous_title;
        }

        uploadForm.addEventListener('submit', function (e) {
            e.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë§‰ê¸°

            const form = e.target;  // ğŸ”§ ì´ê±¸ ë¨¼ì € ì •ì˜í•´ì¤˜ì•¼ ì•„ë˜ì—ì„œ ì‚¬ìš© ê°€ëŠ¥

            if (submitted) {
                return;  // ì´ë¯¸ ì œì¶œí•œ ê²½ìš°
            }
            submitted = true;

            // ë²„íŠ¼ ë¹„í™œì„±í™”í•´ì„œ UIë„ ì¤‘ë³µ ë°©ì§€
            const button = form.querySelector('button[type="submit"]');
            if (button) {
                button.disabled = true;
                button.innerText = "Uploading..."; // UX ê°œì„ 
            }

            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                submitted = false; // ë‹¤ì‹œ ì „ì†¡ ê°€ëŠ¥í•˜ê²Œ
                if (button) {
                    button.disabled = false;
                    button.innerText = "Start Upload";
                }
                return;
            }

            const formData = new FormData(form);
            const xhr = new XMLHttpRequest();

            xhr.open('POST', '/upload/', true);

            // ì§„í–‰ë¥  í‘œì‹œ
            xhr.upload.onprogress = function (e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    document.getElementById('progressContainer').style.display = 'block';
                    document.getElementById('progressBar').value = percent;
                    document.getElementById('percentText').textContent = percent + '%';
                }
            };

            // ì™„ë£Œ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸
            xhr.onload = function () {
                // submitted = false; // ë‹¤ì‹œ ì „ì†¡ ê°€ëŠ¥í•˜ê²Œ
                if (xhr.status === 200) {
                    submitted = false; // ë‹¤ì‹œ ì „ì†¡ ê°€ëŠ¥í•˜ê²Œ
                    // showMessagePopup('âœ” ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    showDebugToast('âœ” ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                    setTimeout(() => {
                        window.location.href = `/upload/?title=${encodeURIComponent(titleInput.value)}`;
                    }, 1000);
                } else {
                    submitted = false; // ë‹¤ì‹œ ì „ì†¡ ê°€ëŠ¥í•˜ê²Œ
                    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + xhr.statusText);
                    if (button) {
                        button.disabled = false;
                        button.innerText = 'Start Upload';
                    }
                }
            };

            xhr.onerror = function () {
                submitted = false;
                alert('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                if (button) {
                    button.disabled = false;
                    button.innerText = 'Start Upload';
                }
            };

            xhr.send(formData);
        });
    });

</script>
</body>
</html>