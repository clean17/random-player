<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image List</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/image.css') }}">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/common.js?v={{ version }}"></script>
</head>
<style>
    #progress-fill {
        white-space: nowrap;
    }
    #progress-text {
        padding-left: 20px;
    }
</style>
<body>
<div class="top-bar">
    <div class="logout">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">Logout</a>
        {% endif %}
    </div>
    <div class="back">
        <a href="{{ url_for('main.home') }}">Back</a>
    </div>
</div>
<div class="scroll-buttons">
    <button onclick="window.scrollTo({ top: 0, behavior: 'auto' })">⬆</button>
    <button onclick="window.scrollTo({ top: document.body.scrollHeight, behavior: 'auto' })">⬇</button>
</div>
<div class="container">
    <div id="progress-bar" style="width:100%; border:1px solid #ccc;">
        <div id="progress-fill" style="width:0; height:25px; background:#4caf50; color:#020202; text-align:center;">
            <span id="progress-text"></span>
        </div>
    </div>
    <div id="progress-status"></div>
    <!-- 드롭다운 리스트 추가 -->
    <div class="dropdown-selector">
        <form id="market-form">
            <label for="market-select">Select Market:</label>
            <select id="market-select" name="market" onchange="location = this.value;">
                <option value="{{ url_for('image.stock-graph-list', market='kospi', page=1) }}" {% if market == 'kospi' %}selected{% endif %}>KOSPI</option>
                <option value="{{ url_for('image.stock-graph-list', market='nasdaq', page=1) }}" {% if market == 'nasdaq' %}selected{% endif %}>NASDAQ</option>
            </select>
        </form>
    </div>

    <div id="delete-form" {#method="POST" action="{{ url_for('image.delete-images') }}"#}>
        <input type="hidden" name="page" value="{{ page }}">
        <div class="image-container">
            {% for image in images %}
            <div class="image-item" id="image-{{ loop.index }}">
                <!-- 처음 5개 이미지만 실제 이미지 로드 -->
                <img class="thumbnail"
                     src="{% if loop.index <= 5 %}{{ url_for('image.stock-graphs', market=market, filename=image) }}{% else %}{{ url_for('static', filename='no-image.png') }}{% endif %}"
                     data-src="{{ url_for('image.stock-graphs', market=market, filename=image) }}"
                     alt="{{ image }}" data-index="{{ loop.index }}">
                <input type="hidden" name="images[]" value="{{ image }}">
            </div>
            {% endfor %}
        </div>
        <div class="pagination">
            {% if page > 1 %}
            <a href="{{ url_for('image.stock-graph-list', market=market, page=1) }}">&laquo;</a>
            <a href="{{ url_for('image.stock-graph-list', market=market, page=page-1) }}">&lt;</a>
            {% endif %}
            {% for p in range(max(1, page - 2), min(total_pages, page + 2) + 1) %}
            <a href="{{ url_for('image.stock-graph-list', market=market, page=p) }}" class="{{ 'active' if p == page else '' }}">{{ p }}</a>
            {% endfor %}
            {% if page < total_pages %}
            <a href="{{ url_for('image.stock-graph-list', market=market, page=page+1) }}">&gt;</a>
            <a href="{{ url_for('image.stock-graph-list', market=market, page=total_pages) }}">&raquo;</a>
            {% endif %}
        </div>
    </div>
</div>


<script src="/static/js/image.js?v={{ version }}"></script>
<script>
    const stock_name = `{{market}}`


    function moveImage(event) {
        const imgElement = event.target;
        const filename = imgElement.getAttribute('alt');
        const market = document.querySelector('#market-select');
        const marketName = market.options[market.selectedIndex].text.toLowerCase();

        fetch(`/image/move-stock-image/${encodeURIComponent(marketName)}/${encodeURIComponent(filename)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const imageElement = imgElement.closest('.image-item');
                    if (imageElement) {
                        const nextImageElement = imageElement.nextElementSibling;
                        imageElement.remove();
                        if (nextImageElement) {
                            nextImageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function updateProgressBar(data) {
        console.log(data)
        const fill = document.getElementById('progress-fill');
        fill.style.width = data.percent + '%';
        const fillText = document.getElementById('progress-text');
        fillText.textContent = data.done ? data.percent + '%' : data.percent + '% ' + '(' + data.count + '/' + data.total_count + ')  ' + '[ '+ data.ticker + ' ] ' + data.stock_name;
        document.getElementById('progress-status').textContent = data.done ? '완료' : '';
    }

    function pollProgress(stock) {
        fetch('/func/stocks/progress/'+stock)
            .then(resp => {
                if (!resp.ok) throw new Error('네트워크 오류 또는 인증 필요');
                return resp.json();
            })
            .then(data => {
                updateProgressBar(data);
                if (!data.done) setTimeout(()=> pollProgress(stock), 1000);
                else document.getElementById('progress-status').textContent = '완료';
            })
            .catch(err => {
                document.getElementById('progress-status').textContent = '에러 발생: ' + err.message;
            });
    }

    function initPage() {
        pollProgress(stock_name);

        // 이미지 클릭 & 다음 버튼 > 다음 이미지를 센터로
        imageItems = document.querySelectorAll('.image-item');
        lazyImages = document.querySelectorAll("img[data-src]");

        imageItems.forEach(item => {
            const img = item.querySelector('.thumbnail');
            img.addEventListener('click', () => {
                if (confirm('Delete the file ?')) {
                    moveImage(event);
                }
            });
        });

        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case 'ArrowRight':
                case 'ArrowDown':
                case 'PageDown':
                    event.preventDefault();
                    nextImage();
                    break;
                case 'ArrowLeft':
                case 'ArrowUp':
                case 'PageUp':
                    event.preventDefault();
                    previousImage();
                    break;
                case ' ': case 'Enter':
                    event.preventDefault();
                    clickCenterImage();
                    break;
                case 'Delete':
                    event.preventDefault();
                    if (confirm('Are you sure?')) {
                        const centerImage = getCenterImage();
                        if (centerImage) {
                            moveImage({ target: centerImage.querySelector('img') }); // 키보드 이벤트로 삭제
                        }
                    }
                    break;
                default: break;
            }
        });
    }

    document.addEventListener("DOMContentLoaded", initPage)
</script>
</body>
</html>
